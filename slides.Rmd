---
title: |-
  MATH513
  Big Data and Social Network Visualization
  Practical #Homeworkout vs #Gym
author: '10546918'
date: "`r Sys.Date()`"
output:
  ioslides_presentation: default
  beamer_presentation: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r, echo=FALSE, include=FALSE,}
# loading libraries
library(rtweet)
library(ggplot2)
library(dplyr)
library(ggthemes)
library(readr)
library(jsonlite)
library(tidytext)
library(wordcloud)
library(wordcloud2)
library(tidyr)
library(maps)
library(scales)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
#
#setting the working directory
setwd("C:/Users/kwsta/master_projects/Math513/CRW_presentation")
#
# makes a dataframe out of a json file
# read the data from the .json files
hash_homeworkout_tweets <- stream_in(file("hash_homeworkout_tweets.json"))
hash_gym_tweets <- stream_in(file("hash_gym_tweets.json"))
#
```

```{r function_chunk, include=FALSE}
#
#creating functions
#
# Top locations
# 
plot_top_locations <- function(x, title_end = ' ', fill = 'blue') {x %>%
    count(location_rec, sort = TRUE) %>%
    mutate(location_rec = reorder(location_rec, n)) %>%
    na.omit() %>%
    head(10) %>%
    ggplot(aes(x = location_rec, y = n))+
    geom_col(fill = fill ) +
    coord_flip() +
    labs(x = "Location",
         y = "Number of tweets",
         title = paste("Top locations which tweeted:", title_end, sep = ' '),
         caption = 'Data Source: Twitter (derived using rtweet)') + 
    theme(axis.text = element_text(size = 16, color = "black"), 
          axis.title = element_text(size = 16, color = "black"),
          plot.title = element_text(size = 18, face = 'bold'),
          plot.caption = element_text(size = 11, face = 'italic'))
    }
#  
# Joining similar locations
#
join_similar_locations <- function(x){x %>%
    mutate(location_rec = 
             recode(location, 'United States' = 'USA', 
                    'US' = 'USA', 'Chicago' = 'Chicago, IL', 
                    "London, England" = "London", 
                    "London, UK" = "London", 
                    "South East, England" = 'United Kingdom',
                    "UK" = "United Kingdom", "u.k." = "United Kingdom",
                    "United Kingdom, EU" = "United Kingdom",
                    "England, United Kingdom" = "United Kingdom",
                    "united kingdom" = "United Kingdom",
                    "EU" = "European Union"
                    )
           )
  
    }
#
# function for the creation of a data frame with just the tweet texts, usernames and location data
#
create_lean_df <- function(df){ data.frame(date_time = df$created_at,
                                            username = df$screen_name,
                                            tweet_text = df$text,
                                            long = df$lng,
                                            lat = df$lat)
    }
```

```{r, echo=FALSE}
#
# Cleaning data
#
# dealing with blank locations
#
hash_homeworkout_tweets$location[hash_homeworkout_tweets$location==""] <- NA
hash_gym_tweets$location[hash_gym_tweets$location==""] <- NA
#
# A location named "Nothing just happens." spotted. We clean it up since is not meaningful
#
hash_gym_tweets$location[hash_gym_tweets$location=="Nothing just happens."] <- NA
#
# Joining the similar locations with the join_similar_locations function we made previously
#
hash_homeworkout_tweets_recoded <- join_similar_locations(hash_homeworkout_tweets)
hash_gym_tweets_recoded <- join_similar_locations(hash_gym_tweets)
```
## TOP LOCATIONS
```{r top_location_home, echo=FALSE, eval=FALSE}
# 
# Visuals for #homeworkout
# we did not included those graphs in the final presentation since we have the grid graph illustrating both
plot_top_locations(hash_homeworkout_tweets_recoded, '#homeworkout', "tomato")
```

```{r top_location_gym, echo=FALSE, eval=FALSE}
#
# visuals for #gym
plot_top_locations(hash_gym_tweets_recoded, '#gym', "steelblue")
```

```{r top_locations_facet_grid, echo=FALSE, message=FALSE}
#
# we bind the "hash_homeworkout_tweets" and "hash_gym_tweets" in order to create a facet_grid
#
# firstly we use mutate in order to create a column called tweet so we can 
# group_by them using their particular value (#homeworktout and #gym)
#
hash_homeworkout_tweets_m <- hash_homeworkout_tweets_recoded %>%
  mutate(tweet = '#homeworkout')
#
hash_gym_tweets_m <- hash_gym_tweets_recoded %>%
  mutate(tweet = '#gym')
#
# use rbind() to bind the together
#
binded_tweets <- rbind(hash_homeworkout_tweets_m, hash_gym_tweets_m)
#
# use the join_similar_locations function we made
#
binded_tweets_r <- join_similar_locations(binded_tweets)
#
# visual
#
binded_tweets_r %>%
  select(tweet, location_rec) %>% # just selecting the columns we need
  group_by(tweet) %>%
  count(location_rec) %>%
  na.omit() %>%
  arrange(desc(n)) %>%  # we faced a problem using head() with the binded data, 
  slice_head(n = 5) %>% # so instead we used arrange(desc) to sort the data, and then slice_head(5) to pick the first 5 results
  ggplot(aes(x = location_rec,y = n, fill = tweet)) +
  geom_col() +
  coord_flip() +
  labs(x = "Top Locations",
       y = "Frequency",
       fill = "Tweets",
       title = "Top locations of #gym and #homeworkout tweets",
       caption = 'Data Source: Twitter (derived using rtweet)') +
  theme(axis.text = element_text(size = 16, color = "black"),
        axis.title = element_text(size = 16, color = "black"),
        plot.title = element_text(size = 18, face = 'bold'),
        legend.title = element_text(size = 16, face = 'bold'),
        plot.caption = element_text(size = 11, face = 'italic')) +
  scale_fill_manual(values = c("#homeworkout" = "tomato", 
                               "#gym" = "steelblue")) +
  facet_grid(tweet~ ., scales ='free')
```
##WORLD MAP
```{r worldmap_pre_code, echo = FALSE, message=FALSE}
# 
# create variables indicating latitude and longitude using all available 
# tweet and profile geo-location data
#
hash_homeworkout_tweets_map <- lat_lng(hash_homeworkout_tweets)
hash_gym_tweets_map <- lat_lng(hash_gym_tweets)
#
# we create new data frame with just the tweet texts, user-names and location data
# using the create_lean_df function we made (see "function_chunk" chunk in the beginning of the script)
#
hash_homeworkout_tweets_map_s <- create_lean_df(hash_homeworkout_tweets_map)
#
hash_gym_tweets_map_s <- create_lean_df(hash_gym_tweets_map)
#
# remove na values
#
hash_homeworkout_locations  <- hash_homeworkout_tweets_map_s %>%
  na.omit()
#
hash_gym_locations  <- hash_gym_tweets_map_s %>%
  na.omit()
#
# round latitude and longitude and group close tweets
#
hash_homeworkout_locations_grp <- hash_homeworkout_locations %>%
  mutate(long_round = round(long, 2),
         lat_round = round(lat, 2)) %>%
  group_by(long_round, lat_round) %>%
  summarise(total_count = n()) %>%
  ungroup() 
#
hash_gym_locations_grp <- hash_gym_locations %>%
  mutate(long_round = round(long, 2),
         lat_round = round(lat, 2)) %>%
  group_by(long_round, lat_round) %>%
  summarise(total_count = n()) %>%
  ungroup() 
#
# binding the hash_homeworkout_locations_grp and hash_gym_locations_grp together 
# so we could plot them easily in the same plot
#
hash_homeworkout_locations_grp_m <- hash_homeworkout_locations_grp %>%
  mutate(tweet = '#homeworkout')
#
hash_gym_locations_grp_m <- hash_gym_locations_grp %>%
  mutate(tweet = '#gym')
#
bind_location_grp <- rbind(hash_homeworkout_locations_grp_m, hash_gym_locations_grp_m)

#
# Plots tweet data about #homeworkout and #gym grouping close tweets and 
# using larger points to show higher frequency
#
# we first have to create a basemap of the globe
# the theme_map() function cleans up the look of the map
#
world_basemap <- ggplot() +
  borders("world", colour = "gray85", fill = "gray80") +
  theme_map()
# 
# worldmap visual
#
world_basemap + 
  geom_point(data = bind_location_grp,
             aes(long_round, lat_round, size = total_count, colour = tweet),
              alpha = 0.4) + 
  coord_fixed() +
  labs(title = "Twitter Activity and locations of #homeworkout vs #gym",
       size = "Number of Tweets",
       colour = 'Tweet',
       caption = 'Data Source: Twitter (derived using rtweet)') +
  theme(
    plot.title = element_text(size=22, face = 'bold'),
    plot.caption = element_text(size=11, face = 'italic'),
    legend.background = element_rect(colour = "black"),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 13),
    legend.key.size = unit(1, "lines")  
  ) +
  scale_color_manual(values = c("#homeworkout" = "tomato", 
                               "#gym" = "steelblue"))
```